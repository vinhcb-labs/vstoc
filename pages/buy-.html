<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>VSTOC — Buy</title>
  <link rel="stylesheet" href="../assets/style.css">
  <style>
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px} @media (max-width:860px){.grid{grid-template-columns:1fr}}
    .card{border:1px solid var(--muted);border-radius:12px;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .mini{font-size:14px;opacity:.9}
    .btn{border:1px solid var(--primary);background:var(--primary);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
    .btn.secondary{background:transparent;color:var(--text);border-color:var(--muted)}
    .search{border:1px solid var(--muted);border-radius:10px;padding:10px}
    .qrBox{display:flex;gap:14px;align-items:flex-start}
    img.qr{max-width:260px;border-radius:12px;border:1px solid var(--muted)}
    .note-field{width:360px;max-width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--muted);background:var(--bg);color:var(--text);font-weight:600;letter-spacing:.2px}
    .pay-guide{margin-top:16px;border-left:4px solid var(--primary);}
    .pay-guide h3{margin:0 0 8px 0}
    .pay-guide ol{margin:8px 0 0 22px}
    .pay-guide li{margin:6px 0}
    .tip{border:1px dashed var(--muted);border-radius:10px;padding:10px;margin-top:10px}
    .ok{color:#22c55e} .warn{color:#eab308} .err{color:#ef4444}
  </style>
</head>
<body>
  <div class="wrap">
    <h2>BUY</h2>
    <p class="mini">Thanh toán qua MoMo bằng mã QR.</p>

    <div class="grid">
      <article class="card">
        <h3>Chọn gói & thông tin nhận key</h3>
        <div class="row">
          <select id="plan" class="search" style="width:240px">
            <option value="490000" data-name="Pro (1 năm)">Pro — 490.000 ₫ / năm</option>
            <option value="1490000" data-name="Business (1 năm)">Business — 1.490.000 ₫ / năm</option>
            <option value="1990000" data-name="Lifetime">Lifetime — 1.990.000 ₫ (trọn đời)</option>
          </select>
          <input id="email" class="search" placeholder="Email nhận key" style="width:280px"/>
          <button class="btn" id="payBtn" type="button">Tạo đơn & Hiển thị QR</button>
        </div>
        <p class="mini" id="orderInfo" style="margin:6px 0 0 0"></p>
        <div style="height:1px;background:var(--muted);margin:16px 0"></div>
        <div class="mini">Sau khi thanh toán, bấm <b>Đã thanh toán</b> ở thẻ QR để gửi xác nhận.</div>
      </article>

      <article class="card">
        <h3>Thanh toán qua MoMo (QR)</h3>
        <div class="qrBox">
          <img class="qr" src="../assets/momo-qr.png" alt="MoMo QR">
          <div>
            <div class="mini"><b>Số tiền</b></div>
            <div class="row"><input id="amountField" class="note-field" readonly value="—"><button class="btn" id="copyAmt">Copy số tiền</button></div>
            <div class="mini" style="margin-top:8px"><b>Nội dung chuyển khoản</b></div>
            <div class="row"><input id="noteField" class="note-field" readonly value="—"><button class="btn" id="copyNote">Copy nội dung</button></div>
            <div class="row" style="margin-top:8px">
              <button class="btn" id="paidBtn" type="button">Đã thanh toán</button>
              <a class="btn secondary" id="paidMailto" style="display:none">Gửi email thủ công</a>
            </div>
            <div id="paidStatus" class="mini" style="margin-top:8px"></div>
            <div class="mini tip">Nếu Discord & Email cùng lỗi, hệ thống sẽ mở email dự phòng để bạn gửi tay.</div>
          </div>
        </div>
      </article>
    </div>

    <section class="card pay-guide">
      <h3>Hướng dẫn thanh toán</h3>
      <ol class="mini">
        <li>Chọn gói & nhập <b>email nhận key</b>.</li>
        <li>Bấm <b>Tạo đơn & Hiển thị QR</b> để tạo <b>mã đơn</b> và điền sẵn <b>Số tiền</b> + <b>Nội dung chuyển khoản</b>.</li>
        <li>Quét QR bằng <b>MoMo</b> hoặc <b>VietQR</b>; dán đúng nội dung & số tiền.</li>
        <li>Chuyển khoản xong, bấm <b>Đã thanh toán</b> để gửi xác nhận (Discord + Email).</li>
      </ol>
    </section>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
  (function(){
    const plan = document.getElementById('plan');
    const email = document.getElementById('email');
    const amountField = document.getElementById('amountField');
    const noteField = document.getElementById('noteField');
    const orderInfo = document.getElementById('orderInfo');

    // Discord webhook & EmailJS config (public only)
    const DISCORD_WEBHOOK = 'https://discord.com/api/webhooks/1413724237981679637/d3sPSuYaGyq4sAr_h-V9TMnf4AcnNv761tD4hoHK0IGH2EorJNrNzxnf1rC_UsHwf4Jp';
    const DISCORD_USERNAME = 'VSTOC Bot';
    const DISCORD_AVATAR = '';

    const EMAILJS_PUBLIC_KEY   = 'a2UFiSwx-1WVOyt2a';
    const EMAILJS_SERVICE_ID   = 'vstoc';
    const EMAILJS_TEMPLATE_ID  = 'template_xu6hvol';

    try { emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY }); } catch(e) {}

    function formatVND(v){ try{ return new Intl.NumberFormat('vi-VN',{style:'currency',currency:'VND'}).format(v); }catch(e){ return (v||0).toLocaleString('vi-VN') + ' ₫'; } }
    function today(){ const d=new Date(); return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`; }
    function newOrderId(){ const rnd=Math.random().toString(36).slice(2,8).toUpperCase(); return `VSTOC-${today()}

        function emailTag(){
          const local = (email.value||'').split('@')[0]||'';
          const norm = local.replace(/[^a-z0-9]/gi,'').slice(0,6);
          return norm || 'user';
        }
        function planCodeFrom(name){
          if(/lifetime/i.test(name)) return 'L';
          if(/business/i.test(name)) return 'B';
          return 'P'; // default Pro
        }
        function yymmdd(){
          const d=new Date();
          return `${String(d.getFullYear()).slice(2)}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`;
        }
        function shortRef(){
          const rnd=Math.random().toString(36).slice(2,6).toUpperCase();
          const planName=plan.options[plan.selectedIndex]?.dataset?.name||'';
          const code=planCodeFrom(planName);
          return `VST${yymmdd()}-${rnd}-${code}-${emailTag()}`;
        }

-${rnd}`; }
    let curOrderId = newOrderId();

    function sync(){
      const v=parseInt(plan.value||'0');
      const planName=plan.options[plan.selectedIndex]?.dataset?.name||'Plan';
      amountField.value = formatVND(v);
      noteField.value = shortRef();
      orderInfo.textContent = `Mã đơn: ${curOrderId} • Gói: ${planName}`;
          noteField.title = `Độ dài: ${noteField.value.length} ký tự`;

      // fallback mailto
      const mail = document.getElementById('paidMailto');
      const subject = 'VSTOC - Confirm Payment';
      const body = `Chào bạn, tôi đã thanh toán MoMo cho gói ${planName}.\nEmail nhận key: ${email.value||'...'}\nMã đơn: ${curOrderId}\nGiá trị: ${amountField.value}`;
      mail.href = `mailto:vinhcb.path@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
    }
    sync();

    document.getElementById('copyAmt').onclick = ()=> navigator.clipboard.writeText(amountField.value);
    document.getElementById('copyNote').onclick = ()=> navigator.clipboard.writeText(noteField.value);
    document.getElementById('payBtn').onclick = ()=>{ curOrderId = newOrderId(); sync(); alert('Đã tạo mã đơn mới. Quét QR và thanh toán nhé.'); };
    email.addEventListener('input', sync); plan.addEventListener('change', sync);

    function buildSharedText({orderId, planName, amountText, buyerEmail, transferContent}){
      const lines = [
        'Đã nhận yêu cầu xác nhận thanh toán VSTOC',
        '• Mã đơn: ' + orderId,
        '• Gói: ' + planName,
        '• Số tiền: ' + amountText,
        '• Email nhận key: ' + buyerEmail,
        '• Nội dung CK: ' + transferContent
      ];
      return lines.join('\n');
    }

    async function sendDiscord(sharedText){
      if (!DISCORD_WEBHOOK) throw new Error('Webhook chưa cấu hình');
      const payload = { username: DISCORD_USERNAME, avatar_url: DISCORD_AVATAR, content: sharedText };
      const res = await fetch(DISCORD_WEBHOOK, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if (!res.ok) throw new Error('Discord trả về lỗi ' + res.status);
      return true;
    }

    async function sendEmailToBuyer({buyerEmail, emailSubject, sharedText, orderId, planName, amountText}){
      if (!buyerEmail) throw new Error('buyerEmail trống');
      const tpl = {
        email_subject: emailSubject,
        message_text: sharedText,
        order_id: orderId,
        plan_name: planName,
        amount_text: amountText,
        buyer_email: buyerEmail
      };
      const res = await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, tpl);
      if (res.status !== 200) throw new Error('EmailJS status ' + res.status);
      return true;
    }

    const paidBtn = document.getElementById('paidBtn');
    const paidMailto = document.getElementById('paidMailto');
    const paidStatus = document.getElementById('paidStatus');

    paidBtn.onclick = async ()=>{
      const planName = plan.options[plan.selectedIndex]?.dataset?.name || 'Plan';
      const buyer = (email.value || '').trim();
      if (!buyer){ paidStatus.textContent='Vui lòng nhập email để nhận xác nhận mua.'; email.focus(); return; }

      const sharedText = buildSharedText({
        orderId: curOrderId,
        planName,
        amountText: amountField.value,
        buyerEmail: buyer,
        transferContent: noteField.value
      });

      const emailSubject = 'Xác nhận thanh toán VSTOC — ' + new Date().toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' }).replace(',', '').replaceAll('/', '-');

      paidStatus.textContent = 'Đang gửi xác nhận (Discord + Email)...';
      paidBtn.disabled = true;
      let discordOK = false, emailOK = false;
      try {
        const results = await Promise.allSettled([
          sendDiscord(sharedText),
          sendEmailToBuyer({ buyerEmail: buyer, emailSubject, sharedText, orderId: curOrderId, planName, amountText: amountField.value })
        ]);
        discordOK = results[0].status === 'fulfilled';
        emailOK   = results[1].status === 'fulfilled';
      } catch(e){ /* shouldn't reach here with allSettled */ }

      if (discordOK && emailOK) paidStatus.innerHTML='Đã gửi Discord <span class="ok">✅</span> và email cho bạn <span class="ok">✅</span>';
      else if (discordOK && !emailOK) paidStatus.innerHTML='Discord <span class="ok">✅</span> nhưng email thất bại <span class="err">❌</span> — kiểm tra lại EmailJS/địa chỉ email.';
      else if (!discordOK && emailOK) paidStatus.innerHTML='Discord lỗi <span class="err">❌</span> — Email xác nhận đã gửi cho bạn <span class="ok">✅</span> (kiểm tra cả Spam/Quảng cáo).';
      else { 
        paidStatus.textContent='Gửi thất bại (Discord & Email). Sẽ mở email dự phòng...'; 
        paidMailto.click(); 
      }
      paidBtn.disabled = false;
    };
  })();
  </script>
</body>
</html>
