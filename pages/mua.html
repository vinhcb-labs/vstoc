
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../assets/style.css">
  <title>VSTOC — MUA</title>
  <style>
  :root{--bg:#0b1018;--panel:#111827;--text:#e5e7eb;--muted:#263042;--primary: #4cc9f0}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  h2{margin:24px 0 6px 0} .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px} @media (max-width:860px){.grid{grid-template-columns:1fr}}
  .card{background:var(--panel);border:1px solid var(--muted);border-radius:12px;padding:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .mini{font-size:14px;opacity:.9}
  .btn{border:1px solid var(--primary);background:var(--primary);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;gap:8px}
  .btn.secondary{background:transparent;color:var(--text);border-color:var(--muted)}
  .search{border:1px solid var(--muted);border-radius:10px;padding:10px;background:#0f172a;color:var(--text)}
  .qrBox{display:flex;gap:14px;align-items:flex-start}
  img.qr{max-width:260px;border-radius:12px;border:1px solid var(--muted);min-width:200px;min-height:200px;background:#0f172a}
  .note-field{width:360px;max-width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--muted);background:#0f172a;color:var(--text);font-weight:600;letter-spacing:.2px}
  .pay-guide{margin-top:16px;border-left:4px solid var(--primary);} .pay-guide h3{margin:0 0 8px 0}
  .pay-guide ol{margin:8px 0 0 22px} .pay-guide li{margin:6px 0}
  .tip{border:1px dashed var(--muted);border-radius:10px;padding:10px;margin-top:10px}
  .ok{color:#22c55e} .warn{color:#eab308} .err{color:#ef4444}
  
/* ===== Mobile fit adjustments for mua.html ===== */
@media (max-width: 680px) {
  .wrap { padding: 12px; }
  .grid { grid-template-columns: 1fr; }
  .qrBox { flex-direction: column; align-items: stretch; gap: 12px; }
  img.qr { width: 100%; max-width: 100%; min-width: 0; height: auto; min-height: 0; }
  .row { width: 100%; gap: 8px; }
  .row .search,
  .row input,
  .row .note-field,
  .row select,
  .row button.btn { width: 100% !important; }
  .row button.btn { justify-content: center; }
  #orderInfo { overflow-wrap: anywhere; word-break: break-word; }
}

</style>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<body>
  <div class="wrap">
    
    <p class="mini">Thanh toán qua VietQR ngân hàng.</p>

    <div class="grid">
      <article class="card">
        <h3>Chọn gói & thông tin nhận key</h3>
        <div class="row">
          <select id="plan" class="search" style="width:240px">
            <option value="490000" data-name="Pro (1 năm)">Pro — 490.000 ₫ / năm</option>
            <option value="1490000" data-name="Business (1 năm)">Business — 1.490.000 ₫ / năm</option>
            <option value="1990000" data-name="Lifetime">Lifetime — 1.990.000 ₫ (trọn đời)</option>
          </select>
          <input id="email" class="search" placeholder="Email nhận key" style="width:280px"/>
          <button class="btn" id="payBtn" type="button">Tạo đơn để hiển thị QR</button>
        </div>
        <p class="mini" id="orderInfo" style="margin:6px 0 0 0"></p>
        <div style="height:1px;background:var(--muted);margin:16px 0"></div>

      </article>

      <article class="card">
        
        <div class="qrBox">
          <img id="qrImg" class="qr" src="" alt="VietQR">
          <div>
            <div class="mini"><b>Số tiền</b></div>
            <div class="row"><input id="amountField" class="note-field" readonly value="—"><button class="btn" id="copyAmt">Copy số tiền</button></div>
            <div class="mini" style="margin-top:8px"><b>Nội dung chuyển khoản</b></div>
            <div class="row"><input id="noteField" class="note-field" readonly value="—"><button class="btn" id="copyNote">Copy nội dung</button></div>
            <div class="row" style="margin-top:8px">
			 <div class="mini">Sau khi chuyển khoản xong, nhấn để gửi xác nhận.</div>
              <button class="btn" id="paidBtn" type="button">Đã thanh toán</button>
              <a class="btn secondary" id="paidMailto" style="display:none">Gửi email thủ công</a>
            </div>
            <div id="paidStatus" class="mini" style="margin-top:8px"></div>

          </div>
        </div>

      </article>
    </div>

    <section class="card pay-guide">
     
      <ol class="mini">
        <li>Chọn gói & nhập <b>email nhận key</b>.</li>
        <li>Bấm <b>Tạo đơn để hiển thị QR</b> để tạo <b>mã đơn</b> và điền sẵn <b>Số tiền</b> + <b>Nội dung chuyển khoản</b>.</li>
        <li>Quét QR bằng <b>VietQR</b> trong ứng dụng ngân hàng.</li>
        <li>Chuyển khoản xong, bấm <b>Đã thanh toán</b> để gửi xác nhận.</li>
      </ol>
    </section>
  </div>

<script>
window.addEventListener('DOMContentLoaded', function initBuy(){
  // Elements
  const plan = document.getElementById('plan');
  const email = document.getElementById('email');
  const amountField = document.getElementById('amountField');
  const noteField = document.getElementById('noteField');
  const orderInfo = document.getElementById('orderInfo');
  const qrImg = document.getElementById('qrImg');

  // Bank config
  const BANK_CODE = 'tcb';
  const BANK_ACCOUNT = '0978705905';
  const BANK_ACCOUNT_NAME = 'BUI CHI VINH';

  // Gateways
  const DISCORD_WEBHOOK = 'https://discord.com/api/webhooks/1413724237981679637/d3sPSuYaGyq4sAr_h-V9TMnf4AcnNv761tD4hoHK0IGH2EorJNrNzxnf1rC_UsHwf4Jp';
  const DISCORD_USERNAME = 'VSTOC';
  const DISCORD_AVATAR = '';

  const EMAILJS_PUBLIC_KEY   = 'a2UFiSwx-1WVOyt2a';
  const EMAILJS_SERVICE_ID   = 'vstoc';
  const EMAILJS_TEMPLATE_ID  = 'template_xu6hvol';

  // Init EmailJS if available
  try { if (window.emailjs) emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY }); } catch(e) { console.warn('EmailJS init failed', e); }

  // Helpers
  function mapEmailJSError(e){
    var t = (e && (e.text || e.message || e.toString())) || '';
    if (/origin/i.test(t) && /(not allowed|forbidden|412|403)/i.test(t)) return "Origin không được phép trên EmailJS. Hãy whitelist: " + location.origin;
    if (/service/i.test(t) && /(not found|404)/i.test(t)) return "SERVICE_ID không đúng trong EmailJS.";
    if (/(user|public key|unauthorized|401)/i.test(t)) return "PUBLIC_KEY sai hoặc chưa init.";
    if (/template/i.test(t) && /(not found|404)/i.test(t)) return "TEMPLATE_ID sai hoặc bị xóa.";
    if (/422/.test(t)) return "Thiếu biến template (ví dụ to_email). Kiểm tra Template.";
    if (/429|rate/i.test(t)) return "Quá hạn mức (rate limit).";
    return t || "Không rõ lỗi.";
  }
  const fmtVND = v => {
    try { return new Intl.NumberFormat('vi-VN',{style:'currency',currency:'VND'}).format(v); }
    catch(e){ return (v||0).toLocaleString('vi-VN') + ' ₫'; }
  };
  const today = () => { const d=new Date(); return `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`; };
  const yymmdd = () => { const d=new Date(); return `${String(d.getFullYear()).slice(2)}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}`; };
  const newOrderId = () => `VSTOC-${today()}-${Math.random().toString(36).slice(2,8).toUpperCase()}`;
  const emailTag = () => ((email.value||'').split('@')[0]||'').replace(/[^a-z0-9]/gi,'').slice(0,6) || 'user';
  const planCode = () => /lifetime/i.test(curPlanName()) ? 'L' : (/business/i.test(curPlanName()) ? 'B' : 'P');
  const curPlanName = () => plan.options[plan.selectedIndex]?.dataset?.name || 'Plan';
  const buildVietQRSrc = (amountVND, addInfo) => {
    const base = `https://img.vietqr.io/image/${BANK_CODE}-${BANK_ACCOUNT}-compact.png`;
    const qs = new URLSearchParams({ amount: String(amountVND||''), addInfo: addInfo||'', accountName: BANK_ACCOUNT_NAME||'' });
    return `${base}?${qs.toString()}`;
  };
  const shortRef = () => `VST${yymmdd()}-${Math.random().toString(36).slice(2,6).toUpperCase()}-${planCode()}-${emailTag()}`;

  let curOrderId = newOrderId();

  function sync(){
    const v = parseInt(plan.value||'0', 10);
    const pName = curPlanName();
    amountField.value = fmtVND(v);
    noteField.value = curOrderId;
    orderInfo.textContent = `${curOrderId} • ${pName}`;
    noteField.title = `Độ dài: ${noteField.value.length} ký tự`;
    if (qrImg) qrImg.src = buildVietQRSrc(v, noteField.value);
  }

  // Bind
  document.getElementById('copyAmt').onclick = ()=> navigator.clipboard.writeText(amountField.value);
  document.getElementById('copyNote').onclick = ()=> navigator.clipboard.writeText(noteField.value);
  document.getElementById('payBtn').onclick = ()=>{ curOrderId = newOrderId(); sync(); alert('Đã tạo mã đơn mới. Quét QR và thanh toán nhé.'); };
  email.addEventListener('input', sync);
  plan.addEventListener('change', sync);

  // Initial fill
  sync();

  // ==== Payment confirmation ====
  const paidBtn = document.getElementById('paidBtn');
  const paidMailto = document.getElementById('paidMailto');
  const paidStatus = document.getElementById('paidStatus');

  function buildSharedText(){
    return [

      '- Xác nhận thanh toán:',
      '• Mã đơn: ' + curOrderId,
      '• Gói: ' + curPlanName(),
      '• Số tiền: ' + amountField.value,
      '• Email: ' + (email.value||'...'),
      '• Nội dung CK: ' + noteField.value
    ].join('\n');
  }

  async function sendDiscord(sharedText){
    if (!DISCORD_WEBHOOK) throw new Error('Webhook chưa cấu hình');
    const payload = { username: DISCORD_USERNAME, avatar_url: DISCORD_AVATAR, content: sharedText };
    const res = await fetch(DISCORD_WEBHOOK, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if (!res.ok) throw new Error('Discord trả về lỗi ' + res.status);
    return true;
  }
  async function sendEmail(buyerEmail, subject, sharedText){
    if (!buyerEmail) throw new Error('buyerEmail trống');
    if (!window.emailjs) throw new Error('EmailJS không khả dụng');
    const tpl = { email_subject: subject, message_text: sharedText, order_id: curOrderId, plan_name: curPlanName(), amount_text: amountField.value, to_email: buyerEmail, buyer_email: buyerEmail };
    const res = await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, tpl, { publicKey: EMAILJS_PUBLIC_KEY });
    if (!res || res.status !== 200) throw new Error('EmailJS status ' + (res && res.status));
    return true;
  }

  const updateMailto = () => {
    const subject = 'VSTOC - Xác nhận thanh toán';
    const body = `Chào bạn, tôi đã thanh toán VietQR cho gói ${curPlanName()}.\nEmail nhận key: ${email.value||'...'}\nMã đơn: ${curOrderId}\nGiá trị: ${amountField.value}`;
    paidMailto.href = `mailto:vinhcb.path@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  };
  updateMailto();

  paidBtn.onclick = async ()=>{
    if (!(email.value||'').trim()){ paidStatus.textContent='Vui lòng nhập email để nhận xác nhận mua.'; email.focus(); return; }
    paidStatus.textContent = 'Đang gửi xác nhận...';
    paidBtn.disabled = true;
    const sharedText = buildSharedText();
    const subject = 'Xác nhận thanh toán — ' + new Date().toLocaleString('vi-VN', { timeZone: 'Asia/Ho_Chi_Minh' }).replace(',', '').replaceAll('/', '-');
    let dOK=false, eOK=false;
    try {
      const results = await Promise.allSettled([ sendDiscord(sharedText), sendEmail(email.value.trim(), subject, sharedText) ]);
      dOK = results[0].status === 'fulfilled'; eOK = results[1].status === 'fulfilled';
      if (!eOK && results[1].reason) paidStatus.textContent = 'Email lỗi: ' + mapEmailJSError(results[1].reason);
    } catch(e) { paidStatus.textContent = 'Email lỗi: ' + mapEmailJSError(e); }
    if (dOK && eOK) paidStatus.innerHTML='Đã gửi thông tin về người bán <span class="ok">✅</span> và email cho bạn <span class="ok">✅</span>';
    else if (dOK && !eOK) paidStatus.innerHTML='Discord <span class="ok">✅</span> nhưng email thất bại <span class="err">❌</span> — kiểm tra lại EmailJS/địa chỉ email.';
    else if (!dOK && eOK) paidStatus.innerHTML='Discord lỗi <span class="err">❌</span> — Email xác nhận đã gửi cho bạn <span class="ok">✅</span> (kiểm tra cả Spam/Quảng cáo).';
    else { paidStatus.textContent='Gửi thất bại (Discord & Email). Sẽ mở email dự phòng...'; updateMailto(); paidMailto.click(); }
    paidBtn.disabled = false;
  };
});
</script>
</body>
</html>
